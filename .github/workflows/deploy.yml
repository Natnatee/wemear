name: Deploy Frontend to VPS

on:
  push:
    branches:
      - main # กำหนดให้ทำงานเมื่อมีการ push ไปที่ branch 'main' เท่านั้น

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ติดตั้ง pnpm ใน GitHub Runner เพื่อให้ Action นี้สามารถเรียกใช้ pnpm ได้
      - name: Install dependencies locally
        run: npm install -g pnpm && pnpm install

      # --- ส่วนสำคัญ: SSH และ Deployment ---
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # คำสั่งทั้งหมดที่จะรันบน VPS ของคุณ
          script: |
            echo "Starting deployment on server with user 'developer' permissions."
            cd /home/developer/wemear

            # 1. ดึงโค้ดล่าสุดจาก GitHub
            git pull origin main 

            # 2. ติดตั้ง Dependencies และ Build Production 
            # (ผู้ใช้ developer สร้างไฟล์ได้ทันที)
            pnpm install        
            pnpm run build      

            # 3. รีโหลด Nginx
            # คำสั่งนี้ยังต้องใช้ sudo เพราะ systemctl ต้องใช้สิทธิ์ระดับ root
            sudo systemctl reload nginx
            echo "Deployment successful and Nginx reloaded."
